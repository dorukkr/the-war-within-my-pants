<!-- apply.html (patched) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apply — The War Within My Pants</title>
  <meta name="description" content="Apply to The War Within My Pants — WoW guild recruitment form." />
  <meta name="theme-color" content="#0b0f17" />

  <!-- Fonts & styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <style>
    .error-message { color:#ff6b6b; font-size:.85rem; margin-top:4px; }
    .field input:invalid, .field select:invalid, .field textarea:invalid { border-color:#ff6b6b; }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <!-- Topbar -->
  <header class="topbar" role="banner">
    <div class="brand">
      <span class="logo-dot" aria-hidden="true"></span> TWWMP
    </div>
    <nav class="nav" aria-label="Primary">
      <a href="/home">Home</a>
      <a href="/about">About Us</a>
      <a href="/members">Members</a>
      <a href="/raids">Raids</a>
      <a href="/media">Media</a>
      <a class="button small" target="_blank" rel="noopener noreferrer" href="https://discord.gg/Zm7QF9D5DS">Discord</a>
    </nav>
  </header>

  <main id="main">
    <!-- Hero -->
    <section id="apply-hero" class="parallax-bg" style="min-height:48vh; padding-top:120px; background-image:url('images/raid.jpg');">
      <div class="content-box" style="text-align:center;">
        <h1>Apply to The War Within My Pants</h1>
        <p>Fill out this form to join our guild. Your answers will be sent directly to the officers on Discord.</p>
        <p style="margin-top:8px;"><a href="/" class="button small">← Back to Home</a></p>
      </div>
    </section>

    <!-- Form -->
    <section id="apply" class="parallax-bg" aria-label="Guild application form" style="background-image:url('images/media.jpg');">
      <div class="content-box fade-in" style="max-width:860px; width:min(92vw,860px); text-align:left;">
        <h2 style="text-align:center;">Application Form</h2>

        <form id="applyForm" novalidate>
          <!-- Honeypot -->
          <input type="text" name="website" id="website" autocomplete="off" tabindex="-1" aria-hidden="true" style="position:absolute; left:-9999px;">

          <div class="form-grid">
  <div class="field">
    <label for="character">Character Name<span class="req">*</span></label>
    <input id="character" name="character" required placeholder="Example: Toxarica, Chop" />
  </div>

  <div class="field">
    <label for="realm">Realm<span class="req">*</span></label>
    <input id="realm" name="realm" required placeholder="Ragnaros (EU)" />
  </div>

  <div class="field">
    <label for="btag">BattleTag<span class="req">*</span></label>
    <input id="btag" name="btag" required placeholder="Name#1234" />
  </div>
  
  <div class="field">
    <label for="discord">Discord <span class="req">*</span></label>
    <input id="discord" name="discord" required placeholder="@mention or username (help us auto-find you)" />
  </div>
</div>
            
            <!-- ⬇️ Class grid DIŞARIDA (full width) ⬇️ -->
<div class="field">
  <label class="label">Class(es) <span class="req">*</span></label>
  <small class="hint" style="margin-bottom:12px; display:block; color:#ddd;">Select your main and alts</small>
  
  <div class="class-grid">
    <!-- Death Knight -->
    <label class="class-card" data-class="death-knight">
      <input type="checkbox" name="class" value="Death Knight" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_deathknight.jpg" alt="Death Knight" class="class-icon" />
      <span class="class-name">Death Knight</span>
    </label>

    <!-- Demon Hunter -->
    <label class="class-card" data-class="demon-hunter">
      <input type="checkbox" name="class" value="Demon Hunter" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_demonhunter.jpg" alt="Demon Hunter" class="class-icon" />
      <span class="class-name">Demon Hunter</span>
    </label>

    <!-- Druid -->
    <label class="class-card" data-class="druid">
      <input type="checkbox" name="class" value="Druid" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_druid.jpg" alt="Druid" class="class-icon" />
      <span class="class-name">Druid</span>
    </label>

    <!-- Evoker -->
    <label class="class-card" data-class="evoker">
      <input type="checkbox" name="class" value="Evoker" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_evoker.jpg" alt="Evoker" class="class-icon" />
      <span class="class-name">Evoker</span>
    </label>

    <!-- Hunter -->
    <label class="class-card" data-class="hunter">
      <input type="checkbox" name="class" value="Hunter" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_hunter.jpg" alt="Hunter" class="class-icon" />
      <span class="class-name">Hunter</span>
    </label>

    <!-- Mage -->
    <label class="class-card" data-class="mage">
      <input type="checkbox" name="class" value="Mage" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_mage.jpg" alt="Mage" class="class-icon" />
      <span class="class-name">Mage</span>
    </label>

    <!-- Monk -->
    <label class="class-card" data-class="monk">
      <input type="checkbox" name="class" value="Monk" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_monk.jpg" alt="Monk" class="class-icon" />
      <span class="class-name">Monk</span>
    </label>

    <!-- Paladin -->
    <label class="class-card" data-class="paladin">
      <input type="checkbox" name="class" value="Paladin" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_paladin.jpg" alt="Paladin" class="class-icon" />
      <span class="class-name">Paladin</span>
    </label>

    <!-- Priest -->
    <label class="class-card" data-class="priest">
      <input type="checkbox" name="class" value="Priest" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_priest.jpg" alt="Priest" class="class-icon" />
      <span class="class-name">Priest</span>
    </label>

    <!-- Rogue -->
    <label class="class-card" data-class="rogue">
      <input type="checkbox" name="class" value="Rogue" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_rogue.jpg" alt="Rogue" class="class-icon" />
      <span class="class-name">Rogue</span>
    </label>

    <!-- Shaman -->
    <label class="class-card" data-class="shaman">
      <input type="checkbox" name="class" value="Shaman" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_shaman.jpg" alt="Shaman" class="class-icon" />
      <span class="class-name">Shaman</span>
    </label>

    <!-- Warlock -->
    <label class="class-card" data-class="warlock">
      <input type="checkbox" name="class" value="Warlock" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_warlock.jpg" alt="Warlock" class="class-icon" />
      <span class="class-name">Warlock</span>
    </label>

    <!-- Warrior -->
    <label class="class-card" data-class="warrior">
      <input type="checkbox" name="class" value="Warrior" />
      <img src="https://render.worldofwarcraft.com/us/icons/56/classicon_warrior.jpg" alt="Warrior" class="class-icon" />
      <span class="class-name">Warrior</span>
    </label>
  </div>
              <small id="classCount" style="color:#ffd36b; margin-top:8px; display:block;">0 selected</small>
</div>

          <div class="field">
            <label class="label">Preferred Roles <span class="req">*</span></label>
            <div class="chips">
              <label><input type="checkbox" name="role" value="Tank"> Tank</label>
              <label><input type="checkbox" name="role" value="Healer"> Healer</label>
              <label><input type="checkbox" name="role" value="DPS"> DPS</label>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="rio">Raider.IO link <span class="req">*</span></label>
              <input id="rio" name="rio" type="url" required placeholder="https://raider.io/characters/eu/..." />
            </div>
            <div class="field">
              <label for="wcl">Warcraft Logs link <span class="req">*</span></label>
              <input id="wcl" name="wcl" type="url" required placeholder="https://www.warcraftlogs.com/character/..." />
            </div>
          </div>

          <div class="field">
            <label for="availability">Raid Times Availability<span class="req">*</span></label>
            <textarea id="availability" name="availability" rows="2" required placeholder="Example: Wed & Sun — 20:30 server; usually available."></textarea>
          </div>

          <div class="field">
            <label for="notes">Anything else we should know?</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Optional: Discord name, offspec, experience, M+ score, goals…"></textarea>
          </div>

          <div class="agree">
            <label><input type="checkbox" id="consent" required> I agree that my answers will be shared with the officers on Discord.</label>
          </div>

          <!-- ⬇⬇ Cloudflare Turnstile widget — Submit'in hemen üstü ⬇⬇ -->
          <div class="field" id="captchaField">
            <label class="label">Human verification <span class="req">*</span></label>
            <div
              class="cf-turnstile"
              data-sitekey="0x4AAAAAABtUfxL7PCymMwKP"
              data-callback="onTurnstileSuccess"
              data-error-callback="onTurnstileError"
              data-expired-callback="onTurnstileExpired">
            </div>
            <small id="captchaError" class="error-msg" style="display:none;">Please complete the verification.</small>
          </div>
          <!-- ⬆⬆ Cloudflare Turnstile widget ⬆⬆ -->

          <div class="actions">
            <button type="submit" class="button-3d pressable" id="applySubmit"><span>Submit Application</span></button>
            <span id="applyStatus" role="status" aria-live="polite"></span>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-left">© <span id="year"></span> The War Within My Pants</div>
      <ul class="footer-links">
        <li><a href="https://discord.gg/Zm7QF9D5DS" target="_blank">Discord</a></li>
        <li><a href="https://raider.io/" target="_blank">Raider.IO</a></li>
        <li><a href="https://www.warcraftlogs.com/" target="_blank">Warcraft Logs</a></li>
        <li><a href="/home">Back to top</a></li>
      </ul>
    </div>
  </footer>
</footer>

  <!-- ⬇️ Success Modal (başlangıçta gizli) ⬇️ -->
  <div id="successModal" class="success-modal" style="display:none;" aria-hidden="true">
    <div class="success-overlay"></div>
    <canvas id="confettiCanvas" class="confetti-canvas"></canvas>
    
    <div class="success-content">
      <div class="success-icon">✓</div>
      <h2 class="success-title">Application Sent!</h2>
      <p class="success-message">Your application has been successfully submitted to our officers. We'll review it soon!</p>
      <button id="successContinue" class="button-3d pressable success-btn">
        <span>Continue</span>
      </button>
    </div>
  </div>

  <!-- (İsteğe bağlı) harici apply.js'in varsa burada kalsın; yoksa sorun değil -->
  <script src="apply.js"></script>

  <!-- Inline validation + Turnstile + /api/apply POST (guarded) -->
  <script>
  (function(){
    if (window.__APPLY_HANDLER__) return; // çifte bağlanmayı engelle
    window.__APPLY_HANDLER__ = true;

    const form = document.getElementById("applyForm");
    const statusEl = document.getElementById("applyStatus");
    const submitBtn = document.getElementById("applySubmit");
    const capErrEl = document.getElementById("captchaError");

    let turnstileToken = "";

    // Turnstile callback'leri (HTML data-attr ile bağlı)
    window.onTurnstileSuccess = (token) => {
      turnstileToken = token || "";
      if (capErrEl) capErrEl.style.display = "none";
    };
    window.onTurnstileError = () => {
      turnstileToken = "";
      if (capErrEl) capErrEl.style.display = "inline";
    };
    window.onTurnstileExpired = () => {
      turnstileToken = "";
      if (capErrEl) capErrEl.style.display = "inline";
    };

    function showError(node, text){
      const wrap = node.closest?.(".field") || node.parentNode;
      const msg = document.createElement("div");
      msg.className = "error-message";
      msg.textContent = text;
      wrap.appendChild(msg);
    }
    function isValidUrl(v){ try { new URL(v); return true; } catch { return false; } }
    function setStatus(txt, ok=false){
      if (!statusEl) return;
      statusEl.textContent = txt || "";
      statusEl.style.color = ok ? "#4ade80" : "#ffd36b";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      // eski hataları temizle
      form.querySelectorAll(".error-message").forEach(el => el.remove());

      // honeypot
      if (form.website && form.website.value.trim() !== "") return;

      let valid = true;
      const character    = document.getElementById("character");
      const realm        = document.getElementById("realm");
      const btag         = document.getElementById("btag");
      const rio          = document.getElementById("rio");
      const wcl          = document.getElementById("wcl");
      const availability = document.getElementById("availability");
      const consent      = document.getElementById("consent");
      const discord      = document.getElementById("discord");  // NEW

      if (!character.value.trim())    { valid=false; showError(character,"This field is required."); }
      if (!realm.value.trim())        { valid=false; showError(realm,"This field is required."); }
      if (!btag.value.trim())         { valid=false; showError(btag,"This field is required."); }
      if (!availability.value.trim()) { valid=false; showError(availability,"This field is required."); }

      if (!rio.value.trim())          { valid=false; showError(rio,"This field is required."); }
      else if (!isValidUrl(rio.value)){ valid=false; showError(rio,"Please enter a valid URL."); }

      if (!wcl.value.trim())          { valid=false; showError(wcl,"This field is required."); }
      else if (!isValidUrl(wcl.value)){ valid=false; showError(wcl,"Please enter a valid URL."); }

      // Discord zorunlu
      if (!discord.value.trim())      { valid=false; showError(discord,"This field is required."); }
      
      
      if (form.querySelectorAll("input[name='role']:checked").length === 0){
        valid=false; showError(form.querySelector(".chips"), "Please select at least one role.");
      }
      if (!consent.checked){
        valid=false; showError(consent, "You must agree before submitting.");
      }
      if (!turnstileToken || turnstileToken === "") {
        valid=false;
        if (capErrEl) capErrEl.style.display = "inline";
        setStatus("Please complete the verification.");
      }

      if (!valid) return;

      // değerleri topla
      const classes = Array.from(document.querySelectorAll("input[name='class']:checked")).map(cb=>cb.value);
      const roles   = Array.from(document.querySelectorAll("input[name='role']:checked")).map(x=>x.value);
      const notes   = (document.getElementById("notes")?.value || "").trim();
      const discordVal = discord.value.trim(); // NEW

       // ⬇️ BURAYA EKLE ⬇️
      if (classes.length === 0) {
        valid = false;
        const classGrid = form.querySelector('.class-grid');
        if (classGrid) {
          const errDiv = document.createElement('div');
          errDiv.className = 'error-message';
          errDiv.textContent = 'Please select at least one class.';
          classGrid.parentElement.appendChild(errDiv);
        }
        return; // Form submit'i durdur
      }

      // UI kilitle
      submitBtn.disabled = true;
      submitBtn.style.opacity = .7;
      setStatus("Submitting…");

      // Discord payload
      const content = `**New Guild Application** — ${character.value.trim()} @ ${realm.value.trim()}`;
      const embed = {
        title: `${character.value.trim()} @ ${realm.value.trim()}`,
        description: notes || "—",
        color: 0xF39C12,
        fields: [
          { name: "BattleTag",  value: btag.value.trim(),                         inline: true },
          { name: "Discord",    value: (discordVal || "—"),                       inline: true },  /* NEW */
          { name: "Class(es)",  value: (classes.length ? classes.join(", ") : "—"), inline: true },
          { name: "Roles",      value: (roles.length ? roles.join(", ") : "—"),   inline: true },
          { name: "Availability", value: availability.value.trim() || "—",        inline: false },
          { name: "Raider.IO",  value: rio.value.trim(),                          inline: false },
          { name: "Warcraft Logs", value: wcl.value.trim(),                       inline: false }
        ],
        timestamp: new Date().toISOString(),
        footer: { text: "TWWMP Apply" }
      };

      try {
        const resp = await fetch("/api/apply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            turnstileToken,
            content,
            embeds:[embed],
            // legacy fallback için ayrıca gönder
            discord: discordVal
          })
        });
        if (!resp.ok) throw new Error("Proxy failed: " + resp.status);
        setStatus("Application received!", true);
        showSuccessModal(); // ⬅️ Redirect yerine modal aç
      } catch (err) {
        console.error(err);
        setStatus("Submission failed. Please try again later.");
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        if (window.turnstile) window.turnstile.reset();
        turnstileToken = "";
      }
    });
  })();
 /* =========================================================
   Class Card Seçim Sayacı
========================================================= */
(() => {
  const form = document.getElementById('applyForm');
  if (!form) return;
  
  const classCount = document.getElementById('classCount');
  if (!classCount) return;
  
  const updateCount = () => {
    const count = form.querySelectorAll('input[name="class"]:checked').length;
    classCount.textContent = count + ' selected';
    classCount.style.color = count > 0 ? '#4ade80' : '#ffd36b';
  };
  
  form.querySelectorAll('.class-card input').forEach(cb => {
    cb.addEventListener('change', updateCount);
  });
  
    updateCount();
})();

/* =========================================================
   Apply Form Success Modal + Confetti
========================================================= */
(() => {
  const modal = document.getElementById('successModal');
  const continueBtn = document.getElementById('successContinue');
  const canvas = document.getElementById('confettiCanvas');
  if (!modal || !continueBtn || !canvas) return;

  const ctx = canvas.getContext('2d', { alpha: true });
  let confetti = [];
  let animationId = null;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  // Confetti Particle
  class Confetto {
    constructor() {
      this.x = Math.random() * canvas.width;
      this.y = -20;
      this.vx = (Math.random() - 0.5) * 4;
      this.vy = Math.random() * 3 + 2;
      this.rotation = Math.random() * 360;
      this.rotationSpeed = (Math.random() - 0.5) * 10;
      this.size = Math.random() * 8 + 4;
      this.color = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'][
        Math.floor(Math.random() * 6)
      ];
      this.gravity = 0.15;
    }

    update() {
      this.x += this.vx;
      this.y += this.vy;
      this.vy += this.gravity;
      this.rotation += this.rotationSpeed;
      this.vx *= 0.99;
    }

    draw() {
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate((this.rotation * Math.PI) / 180);
      ctx.fillStyle = this.color;
      ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
      ctx.restore();
    }
  }

  function animateConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (let i = confetti.length - 1; i >= 0; i--) {
      const c = confetti[i];
      c.update();
      c.draw();

      if (c.y > canvas.height + 20) {
        confetti.splice(i, 1);
      }
    }

    if (confetti.length > 0) {
      animationId = requestAnimationFrame(animateConfetti);
    } else {
      animationId = null;
    }
  }

  function startConfetti() {
    resizeCanvas();
    for (let i = 0; i < 150; i++) {
      confetti.push(new Confetto());
    }
    if (!animationId) animateConfetti();
  }

  // Modal göster
  window.showSuccessModal = function() {
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
    startConfetti();
  };

  // Continue butonu
  continueBtn.addEventListener('click', () => {
    window.location.href = '/thank-you';
  });

  // Window resize
  window.addEventListener('resize', resizeCanvas, { passive: true });
})();
</script>

<!-- Footer year -->
<script>document.getElementById('year').textContent=new Date().getFullYear();</script>

  <!-- Site JS -->
  <script src="script.js"></script>
  <script>document.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible'));</script>

  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</body>
</html>
