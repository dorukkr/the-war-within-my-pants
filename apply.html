<!-- apply.html (patched) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Apply — The War Within My Pants</title>
  <meta name="description" content="Apply to The War Within My Pants — WoW guild recruitment form." />
  <meta name="theme-color" content="#0b0f17" />

  <!-- Fonts & styles -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
  <style>
    .error-message { color:#ff6b6b; font-size:.85rem; margin-top:4px; }
    .field input:invalid, .field select:invalid, .field textarea:invalid { border-color:#ff6b6b; }
  </style>
</head>
<body>
  <a class="skip-link" href="#main">Skip to content</a>

  <!-- Topbar -->
  <header class="topbar" role="banner">
    <div class="brand">
      <span class="logo-dot" aria-hidden="true"></span> TWWMP
    </div>
    <nav class="nav" aria-label="Primary">
      <a href="/home">Home</a>
      <a href="/members">Members</a>
      <a href="/raids">Raids</a>
      <a href="/media">Media</a>
      <a class="button small" target="_blank" rel="noopener noreferrer" href="https://discord.gg/Zm7QF9D5DS">Discord</a>
    </nav>
  </header>

  <main id="main">
    <!-- Hero -->
    <section id="apply-hero" class="parallax-bg" style="min-height:48vh; padding-top:120px; background-image:url('images/raid.jpg');">
      <div class="content-box" style="text-align:center;">
        <h1>Apply to The War Within My Pants</h1>
        <p>Fill out this form to join our guild. Your answers will be sent directly to the officers on Discord.</p>
        <p style="margin-top:8px;"><a href="/" class="button small">← Back to Home</a></p>
      </div>
    </section>

    <!-- Form -->
    <section id="apply" class="parallax-bg" aria-label="Guild application form" style="background-image:url('images/media.jpg');">
      <div class="content-box fade-in" style="max-width:860px; width:min(92vw,860px); text-align:left;">
        <h2 style="text-align:center;">Application Form</h2>

        <form id="applyForm" novalidate>
          <!-- Honeypot -->
          <input type="text" name="website" id="website" autocomplete="off" tabindex="-1" aria-hidden="true" style="position:absolute; left:-9999px;">

          <div class="form-grid">
            <div class="field">
              <label for="character">Character Name<span class="req">*</span></label>
              <input id="character" name="character" required placeholder="Example: Toxarica, Chop" />
            </div>

            <div class="field">
              <label for="realm">Realm<span class="req">*</span></label>
              <input id="realm" name="realm" required placeholder="Ragnaros (EU)" />
            </div>

            <div class="field">
              <label for="btag">BattleTag<span class="req">*</span></label>
              <input id="btag" name="btag" required placeholder="Name#1234" />
            </div>
            
            <div class="field">
              <label for="discord">Discord <span class="req">*</span></label>
              <input id="discord" name="discord" required
                     placeholder="@mention or username e.g. @toxarica or toxarica" />
              <small class="hint">Type your Discord @mention or username (helps us auto-find you).</small>
            </div>
            
            <div class="field">
              <label for="class">Class <span class="req">*</span></label>
              <select id="class" name="class" multiple required>
                <option>Death Knight</option>
                <option>Demon Hunter</option>
                <option>Druid</option>
                <option>Evoker</option>
                <option>Hunter</option>
                <option>Mage</option>
                <option>Monk</option>
                <option>Paladin</option>
                <option>Priest</option>
                <option>Rogue</option>
                <option>Shaman</option>
                <option>Warlock</option>
                <option>Warrior</option>
              </select>
              <small class="hint">Hold CTRL (Windows) or CMD (Mac) to select multiple classes if you also play alts.</small>
            </div>
          </div>

          <div class="field">
            <label class="label">Preferred Roles <span class="req">*</span></label>
            <div class="chips">
              <label><input type="checkbox" name="role" value="Tank"> Tank</label>
              <label><input type="checkbox" name="role" value="Healer"> Healer</label>
              <label><input type="checkbox" name="role" value="DPS"> DPS</label>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label for="rio">Raider.IO link <span class="req">*</span></label>
              <input id="rio" name="rio" type="url" required placeholder="https://raider.io/characters/eu/..." />
            </div>
            <div class="field">
              <label for="wcl">Warcraft Logs link <span class="req">*</span></label>
              <input id="wcl" name="wcl" type="url" required placeholder="https://www.warcraftlogs.com/character/..." />
            </div>
          </div>

          <div class="field">
            <label for="availability">Raid Times Availability<span class="req">*</span></label>
            <textarea id="availability" name="availability" rows="2" required placeholder="Example: Wed & Sun — 20:30 server; usually available."></textarea>
          </div>

          <div class="field">
            <label for="notes">Anything else we should know?</label>
            <textarea id="notes" name="notes" rows="3" placeholder="Optional: Discord name, offspec, experience, M+ score, goals…"></textarea>
          </div>

          <div class="agree">
            <label><input type="checkbox" id="consent" required> I agree that my answers will be shared with the officers on Discord.</label>
          </div>

          <!-- ⬇⬇ Cloudflare Turnstile widget — Submit'in hemen üstü ⬇⬇ -->
          <div class="field" id="captchaField">
            <label class="label">Human verification <span class="req">*</span></label>
            <div
              class="cf-turnstile"
              data-sitekey="0x4AAAAAABtUfxL7PCymMwKP"
              data-callback="onTurnstileSuccess"
              data-error-callback="onTurnstileError"
              data-expired-callback="onTurnstileExpired">
            </div>
            <small id="captchaError" class="error-msg" style="display:none;">Please complete the verification.</small>
          </div>
          <!-- ⬆⬆ Cloudflare Turnstile widget ⬆⬆ -->

          <div class="actions">
            <button type="submit" class="button-3d pressable" id="applySubmit"><span>Submit Application</span></button>
            <span id="applyStatus" role="status" aria-live="polite"></span>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div class="footer-left">© <span id="year"></span> The War Within My Pants</div>
      <ul class="footer-links">
        <li><a href="https://discord.gg/Zm7QF9D5DS" target="_blank">Discord</a></li>
        <li><a href="https://raider.io/" target="_blank">Raider.IO</a></li>
        <li><a href="https://www.warcraftlogs.com/" target="_blank">Warcraft Logs</a></li>
        <li><a href="/home">Back to top</a></li>
      </ul>
    </div>
  </footer>

  <!-- (İsteğe bağlı) harici apply.js'in varsa burada kalsın; yoksa sorun değil -->
  <script src="apply.js"></script>

  <!-- Inline validation + Turnstile + /api/apply POST (guarded) -->
  <script>
  (function(){
    if (window.__APPLY_HANDLER__) return; // çifte bağlanmayı engelle
    window.__APPLY_HANDLER__ = true;

    const form = document.getElementById("applyForm");
    const statusEl = document.getElementById("applyStatus");
    const submitBtn = document.getElementById("applySubmit");
    const capErrEl = document.getElementById("captchaError");

    let turnstileToken = "";

    // Turnstile callback'leri (HTML data-attr ile bağlı)
    window.onTurnstileSuccess = (token) => {
      turnstileToken = token || "";
      if (capErrEl) capErrEl.style.display = "none";
    };
    window.onTurnstileError = () => {
      turnstileToken = "";
      if (capErrEl) capErrEl.style.display = "inline";
    };
    window.onTurnstileExpired = () => {
      turnstileToken = "";
      if (capErrEl) capErrEl.style.display = "inline";
    };

    function showError(node, text){
      const wrap = node.closest?.(".field") || node.parentNode;
      const msg = document.createElement("div");
      msg.className = "error-message";
      msg.textContent = text;
      wrap.appendChild(msg);
    }
    function isValidUrl(v){ try { new URL(v); return true; } catch { return false; } }
    function setStatus(txt, ok=false){
      if (!statusEl) return;
      statusEl.textContent = txt || "";
      statusEl.style.color = ok ? "#4ade80" : "#ffd36b";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      // eski hataları temizle
      form.querySelectorAll(".error-message").forEach(el => el.remove());

      // honeypot
      if (form.website && form.website.value.trim() !== "") return;

      let valid = true;
      const character    = document.getElementById("character");
      const realm        = document.getElementById("realm");
      const btag         = document.getElementById("btag");
      const rio          = document.getElementById("rio");
      const wcl          = document.getElementById("wcl");
      const availability = document.getElementById("availability");
      const consent      = document.getElementById("consent");
      const discord      = document.getElementById("discord");  // NEW

      if (!character.value.trim())    { valid=false; showError(character,"This field is required."); }
      if (!realm.value.trim())        { valid=false; showError(realm,"This field is required."); }
      if (!btag.value.trim())         { valid=false; showError(btag,"This field is required."); }
      if (!availability.value.trim()) { valid=false; showError(availability,"This field is required."); }

      if (!rio.value.trim())          { valid=false; showError(rio,"This field is required."); }
      else if (!isValidUrl(rio.value)){ valid=false; showError(rio,"Please enter a valid URL."); }

      if (!wcl.value.trim())          { valid=false; showError(wcl,"This field is required."); }
      else if (!isValidUrl(wcl.value)){ valid=false; showError(wcl,"Please enter a valid URL."); }

      // Discord zorunlu
      if (!discord.value.trim())      { valid=false; showError(discord,"This field is required."); }

      if (form.querySelectorAll("input[name='role']:checked").length === 0){
        valid=false; showError(form.querySelector(".chips"), "Please select at least one role.");
      }
      if (!consent.checked){
        valid=false; showError(consent, "You must agree before submitting.");
      }
      if (!turnstileToken){
        valid=false;
        if (capErrEl) capErrEl.style.display = "inline";
        setStatus("Please complete the verification.");
      }

      if (!valid) return;

      // değerleri topla
      const classes = Array.from(document.querySelectorAll("#class option:checked")).map(o=>o.value);
      const roles   = Array.from(document.querySelectorAll("input[name='role']:checked")).map(x=>x.value);
      const notes   = (document.getElementById("notes")?.value || "").trim();
      const discordVal = discord.value.trim(); // NEW

      // UI kilitle
      submitBtn.disabled = true;
      submitBtn.style.opacity = .7;
      setStatus("Submitting…");

      // Discord payload
      const content = `**New Guild Application** — ${character.value.trim()} @ ${realm.value.trim()}`;
      const embed = {
        title: `${character.value.trim()} @ ${realm.value.trim()}`,
        description: notes || "—",
        color: 0xF39C12,
        fields: [
          { name: "BattleTag",  value: btag.value.trim(),                         inline: true },
          { name: "Discord",    value: (discordVal || "—"),                       inline: true },  /* NEW */
          { name: "Class(es)",  value: (classes.length ? classes.join(", ") : "—"), inline: true },
          { name: "Roles",      value: (roles.length ? roles.join(", ") : "—"),   inline: true },
          { name: "Availability", value: availability.value.trim() || "—",        inline: false },
          { name: "Raider.IO",  value: rio.value.trim(),                          inline: false },
          { name: "Warcraft Logs", value: wcl.value.trim(),                       inline: false }
        ],
        timestamp: new Date().toISOString(),
        footer: { text: "TWWMP Apply" }
      };

      try {
        const resp = await fetch("/api/apply", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            turnstileToken,
            content,
            embeds:[embed],
            // legacy fallback için ayrıca gönder
            discord: discordVal
          })
        });
        if (!resp.ok) throw new Error("Proxy failed: " + resp.status);
        setStatus("Application received. Redirecting…", true);
        window.location.href = "/thank-you";
      } catch (err) {
        console.error(err);
        setStatus("Submission failed. Please try again later.");
        submitBtn.disabled = false;
        submitBtn.style.opacity = 1;
        if (window.turnstile) window.turnstile.reset();
        turnstileToken = "";
      }
    });
  })();
  </script>

  <!-- Footer year -->
  <script>document.getElementById('year').textContent=new Date().getFullYear();</script>

  <!-- Site JS -->
  <script src="script.js"></script>
  <script>document.querySelectorAll('.fade-in').forEach(el => el.classList.add('visible'));</script>

  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</body>
</html>
